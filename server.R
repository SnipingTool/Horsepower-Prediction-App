library(shiny)
library(ggplot2)
data("mtcars")

shinyServer(function(input, output) {
    
    output$doc <- renderUI({
        HTML("<b>This app generates a model for predicting the horsepower of an automobile through its
        weight. The model is only generated for the points that are selected via the brush on
        the plot.<br>
        A new prediction can be obtained from the model generated by specifying the new weight
        value in the text box.</b>")
    })
    
    fit_lm <- reactive({
        brushed_data <- brushedPoints(mtcars, input$brush1, xvar = "wt", yvar = "hp")
        
        if(nrow(brushed_data) < 3) {
            return(NULL)
        }
        
        lm(hp ~ wt, data = brushed_data)
    })
    
    output$plot <- renderPlot({
        g <- ggplot(mtcars, aes(x = wt, y = hp, color = factor(cyl))) +
            theme(legend.position = "right") +
            labs(x = "Weight (1000 lbs)", y = "Horsepower", color = "No. of Cylinders") +
            geom_point()
        
        if (!is.null(fit_lm())) {
            g <- g + geom_abline(intercept = fit_lm()[[1]][[1]], slope = fit_lm()[[1]][[2]],
                                 color = "black", size = 1)
        }
        
        g
    })
    
    
    lm_pred <- reactive({
        if(is.null(fit_lm())) {
            return("Please select more points")
        }
        else {
            p <- predict(fit_lm(), newdata = data.frame(wt = as.numeric(input$wt)))
            round(as.numeric(p), 2)
        }
    })
    
    output$pred <- renderText({
        lm_pred()
    })
    
    lm_ci <- reactive({
        if(is.null(fit_lm())) {
            return("Please select more points")
        }
        else {
            c <- predict(fit_lm(), newdata = data.frame(wt = as.numeric(input$wt)),
                         interval = "confidence")
            paste(round(as.numeric(c[2]), 2), ", ",
                  round(as.numeric(c[3]), 2),
                  sep = "")
        }
    })
    
    output$ci <- renderText({
        lm_ci()
    })
})